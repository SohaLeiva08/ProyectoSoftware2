<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SCRUMLY</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles/app.css" />
  </head>

  <body>
    <div id="root"></div>

    <script type="text/javascript" src="/config.js"></script>

    <script>
      async function verifyIfUserIsAuthenticated() {
        const token = localStorage.getItem("access_token");

        const response = await fetch(`${window.env.API_URL}/auth/v1/user`, {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
            apikey: window.env.API_KEY,
          },
        });

        const data = await response.json();

        if (!data || !response.ok) {
          window.location.href = "/ui/index.html";
        }
      }

      verifyIfUserIsAuthenticated();
    </script>

    <script
      type="text/javascript"
      src="/infrastructure/services/projects.js"
    ></script>
    <script
      type="text/javascript"
      src="/infrastructure/services/tags.js"
    ></script>
    <script
      type="text/javascript"
      src="/infrastructure/services/tasks.js"
    ></script>
    <script
      type="text/javascript"
      src="/infrastructure/services/task-statuses.js"
    ></script>
    <script
      type="text/javascript"
      src="/infrastructure/services/task-priorities.js"
    ></script>
    <script
      type="text/javascript"
      src="/infrastructure/services/auth.js"
    ></script>
    <script type="text/babel" src="components/navbar/Navbar.js"></script>
    <script
      type="text/babel"
      src="components/current-project/TaskCard.js"
    ></script>
    <script
      type="text/babel"
      src="components/current-project/CurrentProjectHeader.js"
    ></script>
    <script
      type="text/babel"
      src="components/current-project/KanbanColumn.js"
    ></script>
    <script type="text/babel" src="components/Sidebar.js"></script>
    <script type="text/babel" src="components/TaskModal.js"></script>
    <script type="text/babel" src="components/UserProfileModal.js"></script>
    <script type="text/babel" src="components/AddTeamMemberModal.js"></script>
    <script
      type="text/babel"
      src="components/project-modal/TeamMemberSelector.js"
    ></script>
    <script
      type="text/babel"
      src="components/project-modal/ProjectModal.js"
    ></script>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const integrantesIniciales = [];

      const rolesDisponibles = [
        "Frontend Developer",
        "Backend Developer",
        "UI/UX Designer",
        "Project Manager",
        "QA Engineer",
        "DevOps Engineer",
        "Product Owner",
      ];

      const opcionesPrioridad = [
        { id: "bajo", name: "Baja", color: "bg-gray-500" },
        { id: "medio", name: "Media", color: "bg-blue-500" },
        { id: "alto", name: "Alta", color: "bg-yellow-500" },
        { id: "critico", name: "Crítica", color: "bg-red-500" },
      ];

      const generarId = (prefix) => `${prefix}-${Date.now()}`;

      const validarCamposRequeridos = (...campos) =>
        campos.every((campo) => {
          if (typeof campo === "string") return campo.trim() !== "";
          return campo != null;
        });

      const validarImagen = (file) => {
        if (!file) return "No se seleccionó archivo";
        if (!file.type.startsWith("image/")) return "Debe ser una imagen";
        if (file.size > 5 * 1024 * 1024)
          return "La imagen no puede superar los 5MB";
        return null;
      };

      const construirUsuario = ({ id, name, email, role, avatar }) => ({
        id: id || generarId("user"),
        name: (name || "").trim(),
        email: (email || "").trim(),
        role: role || "",
        avatar:
          avatar ||
          `https://i.pravatar.cc/100?u=${encodeURIComponent(email || "guest")}`,
      });

      const construirProyecto = (data, proyectoExistente) => ({
        id: proyectoExistente?.id || generarId("project"),
        name: (data.name || "").trim(),
        description: (data.description || "").trim(),
        tags: data.tags || [],
        assignees: data.assignees || [],
        issues: proyectoExistente?.issues || [],
      });

      const construirTarea = (data, tareaExistente, usuarioActual) => {
        const nowIso = new Date().toISOString();
        const actividad = {
          id: generarId("act"),
          type: tareaExistente ? "update" : "create",
          text: tareaExistente
            ? `Tarea actualizada por ${usuarioActual.name}`
            : `Tarea creada por ${usuarioActual.name}`,
          at: nowIso,
          userId: usuarioActual.id,
        };

        return {
          id: tareaExistente?.id || generarId("issue"),
          title: (data.title || "").trim(),
          description: (data.description || "").trim(),
          tag: data.tag || tags[0],
          assignee: data.assignee || "",
          status: data.status || "porhacer",
          priority: data.priority || "medio",
          date:
            tareaExistente?.date ||
            new Date().toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            }),
          projectId: data.projectId,
          createdAt: tareaExistente?.createdAt || nowIso,
          updatedAt: nowIso,
          dueDate: data.dueDate || null,
          activity: [...(tareaExistente?.activity || []), actividad],
        };
      };

      const App = () => {
        const [tags, setTags] = useState([]);
        const [projects, setProjects] = useState([]);
        const [taskStatuses, setTaskStatuses] = useState([]);
        const [taskPriorities, setTaskPriorities] = useState([]);
        const [integrantes, setIntegrantes] = useState(integrantesIniciales);
        const [vistaActiva, setVistaActiva] = useState("kanban");

        const [
          mostrarModalAgregarIntegrante,
          setMostrarModalAgregarIntegrante,
        ] = useState(false);
        const [taskModalIsOpen, setTaskModalIsOpen] = useState(false);
        const [mostrarPerfilUsuario, setMostrarPerfilUsuario] = useState(false);

        const [selectedProjectId, setSelectedProjectId] = useState(null);
        const [projectModalIsOpen, setProjectModalIsOpen] = useState(false);

        const [selectedTaskId, setSelectedTaskId] = useState(null);
        const [etiquetaSeleccionada, setEtiquetaSeleccionada] = useState(null);
        const [terminoBusqueda, setTerminoBusqueda] = useState("");

        const loadInitialData = async () => {
          const tags = await window.getTags();
          const projects = await window.getProjects();
          const taskStatuses = await window.getTaskStatuses();
          const taskPriorities = await window.getTaskPriorities();
          setTags(tags);
          setProjects(projects);
          setTaskStatuses(taskStatuses);
          setTaskPriorities(taskPriorities);
        };

        useEffect(() => {
          loadInitialData();
        }, []);

        const [usuarioActual, setUsuarioActual] = useState(() => {
          try {
            const savedUser = localStorage.getItem("usuarioActual");
            if (savedUser) return JSON.parse(savedUser);
            const userEmail = localStorage.getItem("userEmail");
            const userName = localStorage.getItem("userName");
            if (userEmail && userName) {
              const newUser = {
                id: generarId("user"),
                name: userName,
                email: userEmail,
                role: "User",
                avatar: `https://i.pravatar.cc/100?u=${encodeURIComponent(
                  userEmail
                )}`,
              };
              localStorage.setItem("usuarioActual", JSON.stringify(newUser));
              return newUser;
            }
          } catch (e) {}
          return {
            id: "user-guest",
            name: "Invitado",
            email: "guest@example.com",
            role: "User",
            avatar: "https://i.pravatar.cc/100?u=guest",
          };
        });

        const [barraLateralAbierta, setBarraLateralAbierta] = useState(false);
        const [currentProject, setCurrentProject] = useState(null);

        const loadProjectById = async () => {
          const project = await window.getProjectById(selectedProjectId);

          if (!project) return;

          setCurrentProject(project);
        };

        useEffect(() => {
          if (selectedProjectId) {
            loadProjectById();
          }
        }, [selectedProjectId]);

        const obtenerInfoAsignado = (assigneeIds) =>
          assigneeIds.map((id) =>
            integrantes.find((member) => member.id === id)
          );

        const moverTarea = async (taskId, newStatusId) => {
          await window.updateTaskById({
            taskId: taskId,
            task: {
              status_id: newStatusId,
            },
          });

          loadProjectById();
        };

        const agregarIntegrante = (memberData) => {
          setIntegrantes([...integrantes, memberData]);
          setMostrarModalAgregarIntegrante(false);
        };

        const quitarIntegrante = (memberId) => {
          console.log("hola");
        };

        const eliminarProyecto = async (projectId) => {
          if (
            window.confirm(
              "¿Estás seguro de que quieres eliminar este proyecto? Se perderán todas las tareas."
            )
          ) {
            await window.deleteProjectById(projectId);
            setSelectedProjectId(null);
            setCurrentProject(null);
            loadInitialData();
          }
        };

        const guardarPerfilUsuario = (userData) => {
          setUsuarioActual(userData);
          try {
            localStorage.setItem("usuarioActual", JSON.stringify(userData));
          } catch (e) {}
          setMostrarPerfilUsuario(false);
        };

        const obtenerAccentPrioridad = (id) =>
          ({
            critico: "accent-critical",
            alto: "accent-high",
            medio: "accent-medium",
            bajo: "accent-low",
          }[id] || "accent-medium");

        const obtenerClaseChipPrioridad = (id) =>
          `chip chip-priority-${id || "medium"}`;

        const tareasFiltradas = currentProject?.tasks ?? [];

        return (
          <div className="App">
            <div className="h-screen flex">
              <div
                className={`overlay ${barraLateralAbierta ? "active" : ""}`}
                onClick={() => setBarraLateralAbierta(false)}
              />

              <Sidebar
                barraLateralAbierta={barraLateralAbierta}
                projects={projects}
                setSelectedProjectId={setSelectedProjectId}
                setBarraLateralAbierta={setBarraLateralAbierta}
                setProjectModalIsOpen={setProjectModalIsOpen}
                eliminarProyecto={eliminarProyecto}
                integrantes={integrantes}
                setMostrarModalAgregarIntegrante={
                  setMostrarModalAgregarIntegrante
                }
                quitarIntegrante={quitarIntegrante}
                tags={tags}
                etiquetaSeleccionada={etiquetaSeleccionada}
                setEtiquetaSeleccionada={setEtiquetaSeleccionada}
              />

              <div className="flex-1 min-w-0 bg-white flex flex-col">
                <div className="flex-shrink-0 border-b-2 border-gray-200">
                  <header className="px-4 md:px-6">
                    <Navbar
                      setBarraLateralAbierta={setBarraLateralAbierta}
                      barraLateralAbierta={barraLateralAbierta}
                      terminoBusqueda={terminoBusqueda}
                      setTerminoBusqueda={setTerminoBusqueda}
                      usuarioActual={usuarioActual}
                      setMostrarPerfilUsuario={setMostrarPerfilUsuario}
                    />

                    <CurrentProjectHeader
                      currentProject={currentProject}
                      setSelectedProjectId={setSelectedProjectId}
                      setProjectModalIsOpen={setProjectModalIsOpen}
                      vistaActiva={vistaActiva}
                      setVistaActiva={setVistaActiva}
                      setSelectedTaskId={setSelectedTaskId}
                      setTaskModalIsOpen={setTaskModalIsOpen}
                    />
                  </header>
                </div>

                <div className="flex-1 overflow-auto">
                  {currentProject ? (
                    <div>
                      <div className="p-4 border-b">
                        <p className="text-gray-600">
                          {currentProject?.description}
                        </p>
                        <div className="flex items-center mt-2">
                          <h3 className="text-sm font-medium text-gray-700 mr-2">
                            Asignado a:
                          </h3>
                          <div className="flex -space-x-2">
                            {obtenerInfoAsignado(
                              currentProject?.assignees || []
                            ).map((member) =>
                              member ? (
                                <img
                                  key={member.id}
                                  src={member.avatar}
                                  alt={member.name}
                                  className="avatar border-2 border-white"
                                  title={`${member.name} (${member.role})`}
                                />
                              ) : null
                            )}
                          </div>
                        </div>
                        <div className="flex flex-wrap gap-2 mt-2">
                          {(currentProject?.projects_tags ?? [])
                            .flatMap((projectTag) => projectTag.tags)
                            .map((tag) => (
                              <span
                                key={tag.id}
                                className="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full"
                              >
                                {tag.name}
                              </span>
                            ))}
                        </div>
                      </div>

                      {vistaActiva == "kanban" && (
                        <div className="p-4">
                          <div className="kanban-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            {taskStatuses?.map((taskStatus) => {
                              return (
                                <KanbanColumn
                                  key={taskStatus.id}
                                  taskStatus={taskStatus}
                                  currentProject={currentProject}
                                  moverTarea={moverTarea}
                                  setSelectedTaskId={setSelectedTaskId}
                                  setTaskModalIsOpen={setTaskModalIsOpen}
                                  obtenerAccentPrioridad={
                                    obtenerAccentPrioridad
                                  }
                                  obtenerClaseChipPrioridad={
                                    obtenerClaseChipPrioridad
                                  }
                                  taskPriorities={taskPriorities}
                                />
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {vistaActiva == "list" && (
                        <div className="Tareas">
                          <h3 className="text-lg font-medium text-gray-900 mb-4">
                            Tareas
                          </h3>
                          <div className="grid grid-cols-1 gap-4">
                            {(currentProject?.tasks?.length ?? 0) > 0 ? (
                              tareasFiltradas?.map((issue) => {
                                return (
                                  <TaskCard
                                    key={`list-${issue.id}`}
                                    issue={issue}
                                    setSelectedTaskId={setSelectedTaskId}
                                    setTaskModalIsOpen={setTaskModalIsOpen}
                                    obtenerAccentPrioridad={
                                      obtenerAccentPrioridad
                                    }
                                    obtenerClaseChipPrioridad={
                                      obtenerClaseChipPrioridad
                                    }
                                    taskPriorities={taskPriorities}
                                  />
                                );
                              })
                            ) : (
                              <p className="text-gray-500 text-center py-8">
                                Sin tareas
                              </p>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="flex flex-col items-center justify-center h-full">
                      <p className="text-gray-500 mb-4">
                        No hay proyecto agregado
                      </p>
                      <button
                        className="px-4 py-2 bg-gray-800 text-white rounded-md text-sm font-medium hover:bg-gray-700"
                        onClick={() => {
                          setProjectModalIsOpen(true);
                        }}
                      >
                        Crea tu primer proyecto
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>

            <UserProfileModal
              user={usuarioActual}
              onClose={() => setMostrarPerfilUsuario(false)}
              onSave={guardarPerfilUsuario}
              isOpen={mostrarPerfilUsuario}
            />

            {projectModalIsOpen && (
              <ProjectModal
                projectId={selectedProjectId}
                onClose={() => {
                  setSelectedProjectId(null);
                  setProjectModalIsOpen(false);
                  loadInitialData();
                }}
                tags={tags}
                projectModalIsOpen={projectModalIsOpen}
                integrantes={integrantes}
                onAddNewMember={() => {
                  setMostrarModalAgregarIntegrante(true);
                }}
              />
            )}

            {mostrarModalAgregarIntegrante && (
              <AddTeamMemberModal
                onClose={() => setMostrarModalAgregarIntegrante(false)}
                onSave={agregarIntegrante}
                isOpen={mostrarModalAgregarIntegrante}
              />
            )}

            {taskModalIsOpen && (
              <TaskModal
                taskId={selectedTaskId}
                tags={tags}
                taskStatuses={taskStatuses}
                taskPriorities={taskPriorities}
                onClose={() => {
                  setSelectedTaskId(null);
                  setTaskModalIsOpen(false);
                  loadProjectById();
                }}
                taskModalIsOpen={taskModalIsOpen}
                integrantes={integrantes}
                projectId={currentProject?.id}
                usuarioActual={usuarioActual}
              />
            )}
          </div>
        );
      };

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
